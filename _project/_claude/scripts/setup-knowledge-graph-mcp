#!/bin/bash

# Setup script for mcp-knowledge-graph MCP server with Claude Code
# This script installs and configures the knowledge graph MCP server locally

set -e

echo "üß† Setting up Knowledge Graph MCP Server for Claude Code"
echo "======================================================="

# Get the current directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# Navigate from scripts directory to mcp-knowledge-graph
KG_DIR="$SCRIPT_DIR/../../mcp-knowledge-graph"

# Check if mcp-knowledge-graph directory exists
if [ ! -d "$KG_DIR" ]; then
    echo "‚ùå Error: mcp-knowledge-graph directory not found at $KG_DIR"
    echo "Please ensure this script is run from the directory containing mcp-knowledge-graph/"
    exit 1
fi

echo "üìÅ Found knowledge graph directory at: $KG_DIR"

# Navigate to the knowledge graph directory
cd "$KG_DIR"

# Check if package.json exists
if [ ! -f "package.json" ]; then
    echo "‚ùå Error: package.json not found in $KG_DIR"
    exit 1
fi

# Install dependencies
echo "üì¶ Installing dependencies..."
npm install

# Build the TypeScript project
echo "üî® Building TypeScript project..."
npm run build

# Check if build was successful
if [ ! -f "dist/index.js" ]; then
    echo "‚ùå Error: Build failed - dist/index.js not found"
    exit 1
fi

# Check if visualization template was copied
if [ ! -f "dist/visualization-template.html" ]; then
    echo "‚ùå Error: Build failed - visualization template not found"
    exit 1
fi

echo "‚úÖ Build successful"

# Create memory directory if it doesn't exist
MEMORY_DIR="$HOME/.claude-memory"
if [ ! -d "$MEMORY_DIR" ]; then
    echo "üìÇ Creating memory directory at $MEMORY_DIR"
    mkdir -p "$MEMORY_DIR"
fi

# Configure the MCP server with Claude Code
echo "‚öôÔ∏è  Configuring MCP server with Claude Code..."

# Remove existing knowledge-graph MCP server if it exists
if claude mcp get knowledge-graph >/dev/null 2>&1; then
    echo "üîÑ Removing existing knowledge-graph MCP server..."
    claude mcp remove knowledge-graph
fi

# Add the knowledge graph MCP server
echo "‚ûï Adding knowledge-graph MCP server..."
claude mcp add knowledge-graph -- node "$KG_DIR/dist/index.js" --memory-path "$MEMORY_DIR/knowledge-graph.jsonl"

# Verify the configuration
echo "üîç Verifying configuration..."
if claude mcp get knowledge-graph >/dev/null 2>&1; then
    echo "‚úÖ Knowledge Graph MCP server configured successfully!"
    echo ""
    echo "üìã Configuration details:"
    claude mcp get knowledge-graph
    echo ""
    echo "üíæ Memory file location: $MEMORY_DIR/knowledge-graph.jsonl"
    echo "üéâ Setup complete! You can now use the knowledge graph in Claude Code."
    echo ""
    echo "Available tools:"
    echo "  ‚Ä¢ create_entities - Create new entities in the knowledge graph"
    echo "  ‚Ä¢ create_relations - Create new relations between entities"  
    echo "  ‚Ä¢ add_observations - Add new observations to existing entities"
    echo "  ‚Ä¢ read_graph - Read the entire knowledge graph structure"
    echo "  ‚Ä¢ search_nodes - Search for nodes based on query"
    echo "  ‚Ä¢ open_nodes - Retrieve specific nodes by name"
    echo "  ‚Ä¢ visualize_graph - Generate interactive HTML visualization of the knowledge graph"
    echo "  ‚Ä¢ delete_entities - Remove entities and their relations"
    echo "  ‚Ä¢ delete_observations - Remove specific observations"
    echo "  ‚Ä¢ delete_relations - Remove specific relations"
else
    echo "‚ùå Error: Failed to configure knowledge-graph MCP server"
    exit 1
fi